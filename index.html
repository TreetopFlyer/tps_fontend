<!DOCTYPE html>
<html>
    <head>
        <script src="https://vuejs.org/js/vue.js"></script>
        <style>
        .Frame
        {
            border:1px solid #aaa;
            padding:10px;
        }
        </style>
    </head>
    <body>
        <div id="App">
            <div class="Frame Source New">
                <edit-source
                    create-mode
                    v-on:create="MemberCreate(API.Sources, $event)">
                </edit-source>
            </div>
            <div class="Frame Source Existing" v-for="(sourceValue, sourceKey) in API.Sources">

                <edit-source
                    v-bind="sourceValue"
                    v-on:update="MemberUpdate(API.Sources, sourceKey, $event)"
                    v-on:delete="MemberDelete(API.Sources, sourceKey)">
                </edit-source>
                <div class="Frame Constraint New">
                    <edit-constraint
                        create-mode
                        v-on:create="MemberCreate(sourceValue.constraint, $event.accessor)">
                    </edit-constraint>
                </div>
                <div class="Frame Constraint Existing" v-for="(constraintValue, constraintKey) in sourceValue.constraint">
                    <edit-constraint
                        v-bind:accessor="constraintValue"
                        v-on:update="MemberUpdate(sourceValue.constraint, constraintKey, $event.accessor)"
                        v-on:delete="MemberDelete(sourceValue.constraint, constraintKey)">
                    </edit-constraint>
                </div>

                <div class="Frame Schema New">
                    <edit-schema
                        create-mode
                        v-on:create="MemberCreate(sourceValue.schemas, $event)"/>
                    </edit-schema>
                </div>
                <div class="Frame Schema Existing" v-for="(schemaValue, schemaKey) in sourceValue.schemas">
                    <edit-schema
                        v-bind="schemaValue"
                        v-on:update="MemberUpdate(sourceValue.schemas, schemaKey, $event)"
                        v-on:delete="MemberDelete(sourceValue.schemas, schemaKey)">
                    </edit-schema>
                    <table>
                        <tr>
                            <th class="Frame Column New">
                                <edit-column
                                    create-mode
                                    v-on:create="MemberCreate(schemaValue.columns, $event)">
                                </edit-column>
                            </th>
                            <th class="Frame Column Existing" v-for="(columnValue, columnKey) in schemaValue.columns">
                                <edit-column
                                    v-bind="columnValue"
                                    v-on:update="MemberUpdate(schemaValue.columns, columnKey, $event)"
                                    v-on:delete="MemberDelete(schemaValue.columns, columnKey)">
                                </edit-column>
                            </th>
                        </tr>
                    </table>
                </div>

            </div>

        </div>
    </body>

    <!-- base editor -->
    <script>
    var MixinEditor = {
        props:{
            createMode:{type:Boolean, default:false},
            editMode:{type:Boolean, default:false}
        },
        data:function()
        {
            return {
                Internal:this.CloneFields(this),
                Edit:this.editMode,
                Create:this.createMode
            }
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {};
            },
            EditStart:function()
            {
                this.Edit = true;
                this.Internal = this.CloneFields(this);
            },
            EditUpdate:function()
            {
                this.Edit = false;
                this.$emit('update', this.CloneFields(this.Internal));
            },
            EditCancel:function()
            {
                this.Edit = false;
            },
            EditDelete:function()
            {
                this.Edit = false;
                this.$emit('delete');
            },
            EditCreate:function()
            {
                this.$emit('create', this.CloneFields(this.Internal));
            }
        }
    };
    </script>
        
    <!-- source -->
    <script>
        Vue.component("edit-source", {
            mixins:[MixinEditor],
            props:{
                name:{default:'New Source'},
                source:{default:'New source type'},
                loading_function:{default:'json'},
            },
            methods:{
                CloneFields:function(inObj)
                {
                    return {
                        name: inObj.name,
                        source: inObj.source,
                        loading_function: inObj.loading_function,
                        constraint: [],
                        schemas: []
                    };
                }
            },
            template:"#TemplateSource"
        })
    </script>
    <script id="TemplateSource" type="text/x-template">
        <div>
            <div v-if="Edit || Create">
                <input type="text" v-model="Internal.name">
                <br/>
                <input type="text" v-model="Internal.source">
                <br/>
                <select v-model="Internal.loading_function">
                    <option disabled>{{Internal.type}}</option>
                    <option>csv</option>
                    <option>xml</option>
                    <option>json</option>
                </select>
                <br/>
                <div v-if="Create">
                    <button v-on:click="EditCreate">Create</button>
                </div>
                <div v-else>
                    <button v-on:click="EditUpdate">Update</button>
                    <button v-on:click="EditCancel">Cancel</button>
                    <button v-on:click="EditDelete">Delete</button>
                </div>
            </div>
            <div v-else>
                <strong>{{name}}</strong><br/>
                <span>{{source}}</span><br/>
                <em>{{loading_function}}</em><br/>
                <button v-on:click="EditStart">Edit</button>
            </div>
        </div>
    </script>

    <!-- constraint -->
    <script>
        Vue.component("edit-constraint", {
            mixins:[MixinEditor],
            props:{
                accessor:{default:"{}"}
            },
            methods:{
                CloneFields:function(inObj)
                {
                    return {
                        accessor: inObj.accessor
                    };
                }
            },
            template:"#TemplateConstraint"
        })
    </script>
    <script id="TemplateConstraint" type="text/x-template">
        <div>
            <div v-if="Edit || Create">
                <input type="text" v-model="Internal.accessor">
                <br/>
                <div v-if="Create">
                    <button v-on:click="EditCreate">Create</button>
                </div>
                <div v-else>
                    <button v-on:click="EditUpdate">Update</button>
                    <button v-on:click="EditCancel">Cancel</button>
                    <button v-on:click="EditDelete">Delete</button>
                </div>
            </div>
            <div v-else>
                <p>
                    {{accessor}}
                </p>
                <button v-on:click="EditStart">Edit</button>
            </div>
        </div>
    </script>

    <!-- schema -->
    <script>
    Vue.component("edit-schema", {
        mixins:[MixinEditor],
        props:{
            name:{default:'New Schema'}
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {
                    name: inObj.name,
                    columns: []
                };
            }
        },
        template:"#TemplateHeading"
    });
    </script>
    <script id="TemplateHeading" type="text/x-template">
        <div class="heading">
            <div v-if="Edit || Create">
                <input type="text" v-model="Internal.name">
                <br/>
                <div v-if="Create">
                    <button v-on:click="EditCreate">Create</button>
                </div>
                <div v-else>
                    <button v-on:click="EditUpdate">Update</button>
                    <button v-on:click="EditCancel">Cancel</button>
                    <button v-on:click="EditDelete">Delete</button>
                </div>
            </div>
            <div v-else>
                <strong>{{name}}</strong><br/>
                <button v-on:click="EditStart">Edit</button>
            </div>
        </div>
    </script>

    <!-- column -->
    <script>
    Vue.component("edit-column", {
        mixins:[MixinEditor],
        props:{
            name:{default:'New Column'},
            path:{default:'{path}'},
            type:{default:'text'}
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {
                    name: inObj.name,
                    path: inObj.path,
                    type: inObj.type
                };
            }
        },
        template:"#TemplateColumn"
    });
    </script>
    <script id="TemplateColumn" type="text/x-template">
        <div class="column">
            <div v-if="Edit || Create">
                <input type="text" v-model="Internal.name">
                <br/>
                <input type="text" v-model="Internal.path">
                <br/>
                <select v-model="Internal.type">
                    <option disabled>{{Internal.type}}</option>
                    <option>date</option>
                    <option>numeric</option>
                    <option>text</option>
                </select>
                <br/>
                <div v-if="Create">
                    <button v-on:click="EditCreate">Create</button>
                </div>
                <div v-else>
                    <button v-on:click="EditUpdate">Update</button>
                    <button v-on:click="EditCancel">Cancel</button>
                    <button v-on:click="EditDelete">Delete</button>
                </div>
            </div>
            <div v-else>
                <strong>{{name}}</strong><br/>
                <span>{{path}}</span><br/>
                <em>{{type}}</em><br/>
                <button v-on:click="EditStart">Edit</button>
            </div>
        </div>
    </script>

    <!-- application -->
    <script>
        var App = new Vue({
            el:"#App",
            data:{
                API:{
                    Domain:'//localhost:80',
                    RequestLog:[],
                    Sources:[
                        {
                            name:"dcard",
                            source:"client_file",
                            loading_function:"csv",
                            constraint:["{Trans. Date}","{Post Date}","{Description}"],
                            schemas:[
                                {
                                    name:"mapped",
                                    columns:[
                                        {
                                            name:"Trans. Date",
                                            path:"{Trans.Date}",
                                            type:"date"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            },
            methods:{
                CORS: function(message, url, verb, success)
                {
                    var context = this;
                    var log = {
                        ID:Math.random(),
                        Message:message
                    };
                    context.API.RequestLog.push(log);

                    var xhr = new XMLHttpRequest();
                    if (!('withCredentials' in xhr)) xhr = new XDomainRequest(); // fix IE8/9
                    xhr.open(verb, url);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onload = function(request){
                        
                        var i;
                        for(i=0; i<context.API.RequestLog.length; i++)
                        {
                            if(context.API.RequestLog[i].ID == log.ID)
                            {
                                context.API.RequestLog.splice(i, 1);
                            }
                        }

                        var response = request.currentTarget.response || request.target.responseText;
                        console.log(response);
                        success.call(context, response);
                    };
                    xhr.send();
                    return xhr;
                },
                UpdateSource: function()
                {
                    this.CORS("Loading Sources", this.API.Domain+'/source', "GET", function(inResponse)
                    {
                        this.API.Sources = JSON.parse(inResponse).source_list;
                    });
                },
                ///////////////
                MemberCreate:function(inArray, inValue)
                {
                    console.log("add called", inArray, inValue);
                    inArray.push(inValue);
                },
                MemberUpdate:function(inArray, inIndex, inValue)
                {
                    inArray.splice(inIndex, 1, inValue);
                },
                MemberDelete:function(inArray, inIndex)
                {
                    inArray.splice(inIndex, 1);
                }
            },
            mounted:function()
            {
                //this.UpdateSource();
            }
        });
    </script>
</html>