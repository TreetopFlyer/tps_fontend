<!DOCTYPE html>
<html>
    <head>
        <script src="https://vuejs.org/js/vue.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">
        <link href="icomoon/font.css" rel="stylesheet">
        <style>
            *
            {
                position:relative;
                font-family:Roboto, sans-serif;
            }
            h1, h2, h3, h4, h5, h6
            {
                font-family:Open Sans, sans-serif;
            }
            body
            {
                margin:0;
            }
            button
            {
                border-radius:5px;
                border:1px;
                padding:3px 8px;
            }
            button:hover
            {
                background:#fc0;
            }
            td
            {
                text-align: left;
                vertical-align: top;
            }
            /*******************/
            .Band
            {

            }
            .Center
            {
                max-width:1170px;
                margin:0 auto;
            }
            .Pad
            {
                padding:1rem;
            }
            .Columns
            {
                overflow:hidden;
            }
            .Columns .Column
            {
                float:left;
            }
            .Column.Large
            {
                width:70%;
            }
            .Column.Small
            {
                width:30%;
            }
            /********************/
            .Band.Header
            {
                background:#000;
                color:#fff;
            }
            .Frame
            {
                border:1px solid rgb(202, 198, 198);
                background:#fff;
                box-shadow:0px 3px 10px rgba(0, 0, 0, 0.2);
                padding:10px;
            }
            .Frame.Source
            {
                margin-bottom:8px;
            }
            button
            {
                cursor:pointer;
            }
            button span
            {
                display:none;
            }
        </style>
    </head>
    <body>
        <div id="App">
            <div class="Band Header">
                <div class="Center">
                    <div class="Pad">
                        <strong>TPS</strong>
                        <button v-on:click="UpdateSource"><i class="icon icon-cloud"></i> Download</button>
                    </div>
                </div>
            </div>
            <div class="Band Sources">
                <div class="Center Columns">
                    <div class="Column Large">
                        <div class="Pad">
                            <h2>Sources</h2>
                            <div class="Frame Source New">
                                <edit-source
                                    create-mode
                                    v-on:create="MemberCreate(API.Sources, $event)">
                                </edit-source>
                            </div>
                            <div class="Frame Source Existing" v-for="(sourceValue, sourceKey) in API.Sources">
                                <edit-source
                                    v-bind="sourceValue"
                                    v-on:update="   MemberUpdate(API.Sources, sourceKey, $event)"
                                    v-on:delete="   MemberDelete(API.Sources, sourceKey)"
                                    v-on:duplicate="MemberDuplicate(API.Sources, sourceKey)">
                                </edit-source>
                
                                <p><i class="icon icon-chevron-right"></i> Constriant:</p>
                                <table>
                                    <tr>
                                        <td class="Frame Constraint New">
                                            <edit-constraint
                                                create-mode
                                                v-on:create="MemberCreate(sourceValue.constraint, $event.accessor)">
                                            </edit-constraint>
                                        </td>
                                        <td class="Frame Constraint Existing" v-for="(constraintValue, constraintKey) in sourceValue.constraint">
                                            <edit-constraint
                                                v-bind:accessor="constraintValue"
                                                v-on:update="   MemberUpdate(sourceValue.constraint, constraintKey, $event.accessor)"
                                                v-on:delete="   MemberDelete(sourceValue.constraint, constraintKey)"
                                                v-on:duplicate="MemberDuplicate(sourceValue.constraint, constraintKey)">
                                            </edit-constraint>
                                        </td>
                                    </tr>
                                </table>
                
                                <p><i class="icon icon-chevron-right"></i> Schemas:</p>
                                <table>
                                    <tr>
                                        <td class="Frame Schema New">
                                            <edit-schema
                                                create-mode
                                                v-on:create="MemberCreate(sourceValue.schemas, $event)"/>
                                            </edit-schema>
                                        </td>
                                        <td class="Frame Schema Existing" v-for="(schemaValue, schemaKey) in sourceValue.schemas">
                                            <edit-schema
                                                v-bind="schemaValue"
                                                v-on:update="   MemberUpdate(sourceValue.schemas, schemaKey, $event)"
                                                v-on:delete="   MemberDelete(sourceValue.schemas, schemaKey)"
                                                v-on:duplicate="MemberDuplicate(sourceValue.schemas, schemaKey)">
                                            </edit-schema>
                                            <p><i class="icon icon-chevron-right"></i> Columns:</p>
                                            <div class="Frame Column New">
                                                <edit-column
                                                    create-mode
                                                    v-on:create="MemberCreate(schemaValue.columns, $event)">
                                                </edit-column>
                                            </div>
                                            <div class="Frame Column Existing" v-for="(columnValue, columnKey) in schemaValue.columns">
                                                <edit-column
                                                    v-bind="columnValue"
                                                    v-on:update="MemberUpdate(schemaValue.columns, columnKey, $event)"
                                                    v-on:delete="MemberDelete(schemaValue.columns, columnKey)"
                                                    v-on:duplicate="MemberDuplicate(schemaValue.columns, columnKey)">
                                                </edit-column>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="Column Small">
                        <div class="Pad">
                            <h2>Output JSON</h2>
                            <textarea style="display:block; width:100%; min-height:400px;">{{JSON}}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <!-- base editor -->
    <script>
    var MixinEditor = {
        props:{
            createMode:{type:Boolean, default:false},
            editMode:{type:Boolean, default:false}
        },
        data:function()
        {
            return {
                Internal:this.CloneFields(this),
                Edit:this.editMode,
                Create:this.createMode
            }
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {};
            },
            EditStart:function()
            {
                this.Edit = true;
                console.log(this.$refs.focus.focus());
                this.Internal = this.CloneFields(this);
            },
            EditUpdate:function()
            {
                this.Edit = false;
                this.$emit('update', this.CloneFields(this.Internal));
            },
            EditCancel:function()
            {
                this.Edit = false;
            },
            EditDelete:function()
            {
                this.Edit = false;
                this.$emit('delete');
            },
            EditCreate:function()
            {
                this.$emit('create', this.CloneFields(this.Internal));
            },
            EditDuplicate:function()
            {
                this.$emit('duplicate');
            }
        }
    };
    </script>
    <script>
    Vue.component("edit-editor", {
        props:{
            create:{default: false},
            edit:{default: false}
        },
        methods:{
            HandlerSubmit:function()
            {
                if(this.create)
                {
                    this.$emit('create');
                }
                if(this.edit)
                {
                    this.$emit('update');
                }
            }
        },
        template:"#TemplateBaseEditor"
    });
    </script>
    <script id="TemplateBaseEditor" type="text/x-template">
        <div>
            <form v-show="create || edit" v-on:submit.prevent="HandlerSubmit">
                <slot name="write"></slot>
                <div class="Controls" v-if="create">
                    <button v-on:click.prevent="$emit('create')"><i class="icon icon-plus-circle"></i> <span>Create</span></button>
                </div>
                <div class="Controls" v-else>
                    <button v-on:click.prevent="$emit('update')"><i class="icon icon-save"></i> <span>Update</span></button>
                    <button v-on:click.prevent="$emit('cancel')"><i class="icon icon-slash"></i> <span>Cancel</span></button>
                </div>
            </form>
            <div v-show="!create && !edit">
                <div class="Controls">
                    <button v-on:click.prevent="$emit('edit')"><i class="icon icon-edit"></i> <span>Edit</span></button>
                    <button v-on:click.prevent="$emit('duplicate')"><i class="icon icon-copy"></i> <span>Duplicate</span></button>
                    <button v-on:click.prevent="$emit('delete')"><i class="icon icon-trash-2"></i> <span>Delete</span></button>
                </div>
                <slot name="read"></slot>
            </div>
        </div>
    </script>
    
    <!-- source -->
    <script>
        Vue.component("edit-source", {
            mixins:[MixinEditor],
            props:{
                name:{default:'New Source'},
                source:{default:'New source type'},
                loading_function:{default:'json'},
            },
            methods:{
                CloneFields:function(inObj)
                {
                    return {
                        name: inObj.name,
                        source: inObj.source,
                        loading_function: inObj.loading_function,
                        constraint: [],
                        schemas: []
                    };
                }
            },
            template:"#TemplateSource"
        })
    </script>
    <script id="TemplateSource" type="text/x-template">
        <edit-editor
            v-bind:create="Create"
            v-bind:edit="Edit"
            @create="EditCreate"
            @update="EditUpdate"
            @delete="EditDelete"
            @edit="EditStart"
            @cancel="EditCancel"
            @duplicate="EditDuplicate">
            <template slot="write">
                <label>Name:</label>
                <input ref="focus" type="text" v-model="Internal.name">
                <br/>
                <label>Source:</label>
                <input type="text" v-model="Internal.source">
                <br/>
                <label>Loading Function:</label>
                <select v-model="Internal.loading_function">
                    <option disabled>{{Internal.type}}</option>
                    <option>csv</option>
                    <option>xml</option>
                    <option>json</option>
                </select>
            </template>
            <template slot="read">
                <h3>{{name}}</h3>
                <p>
                    <i class="icon icon-chevron-right"></i> Source: <strong>{{source}}</strong><br>
                    <i class="icon icon-chevron-right"></i> Loading Function: <strong>{{loading_function}}</strong>
                </p>
            </template>
        </edit-editor>
    </script>

    <!-- constraint -->
    <script>
        Vue.component("edit-constraint", {
            mixins:[MixinEditor],
            props:{
                accessor:{default:"{constraint}"}
            },
            methods:{
                CloneFields:function(inObj)
                {
                    return {
                        accessor: inObj.accessor
                    };
                }
            },
            template:"#TemplateConstraint"
        })
    </script>
    <script id="TemplateConstraint" type="text/x-template">
        <edit-editor
            v-bind:create="Create"
            v-bind:edit="Edit"
            @create="EditCreate"
            @update="EditUpdate"
            @delete="EditDelete"
            @edit="EditStart"
            @cancel="EditCancel"
            @duplicate="EditDuplicate">
            <template slot="write">
                <input type="text" v-model="Internal.accessor">
            </template>
            <template slot="read">
                <p>
                    {{accessor}}
                </p>
            </template>
        </edit-editor>
    </script>

    <!-- schema -->
    <script>
    Vue.component("edit-schema", {
        mixins:[MixinEditor],
        props:{
            name:{default:'New Schema'}
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {
                    name: inObj.name,
                    columns: []
                };
            }
        },
        template:"#TemplateHeading"
    });
    </script>
    <script id="TemplateHeading" type="text/x-template">
        <edit-editor
            v-bind:create="Create"
            v-bind:edit="Edit"
            @create="EditCreate"
            @update="EditUpdate"
            @delete="EditDelete"
            @edit="EditStart"
            @cancel="EditCancel"
            @duplicate="EditDuplicate">
            <template slot="read">
                <h4>{{name}}</h4>
            </template>
            <template slot="write">
                <input type="text" v-model="Internal.name">
            </template>
        </edit-editor>
    </script>

    <!-- column -->
    <script>
    Vue.component("edit-column", {
        mixins:[MixinEditor],
        props:{
            name:{default:'New Column'},
            path:{default:'{path}'},
            type:{default:'text'}
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {
                    name: inObj.name,
                    path: inObj.path,
                    type: inObj.type
                };
            }
        },
        template:"#TemplateColumn"
    });
    </script>
    <script id="TemplateColumn" type="text/x-template">
        <edit-editor
            v-bind:create="Create"
            v-bind:edit="Edit"
            @create="EditCreate"
            @update="EditUpdate"
            @delete="EditDelete"
            @edit="EditStart"
            @cancel="EditCancel"
            @duplicate="EditDuplicate">
            <template slot="write">
                <input type="text" v-model="Internal.name">
                <br/>
                <input type="text" v-model="Internal.path">
                <br/>
                <select v-model="Internal.type">
                    <option disabled>{{Internal.type}}</option>
                    <option>date</option>
                    <option>numeric</option>
                    <option>text</option>
                </select>
            </template>
            <template slot="read">
                <h5>{{name}}</h5>
                <span>{{path}}</span><br/>
                <em>{{type}}</em><br/>
            </template>
        </edit-editor>
    </script>

    <!-- application -->
    <script>
        var App = new Vue({
            el:"#App",
            data:{
                API:{
                    Domain:'//localhost:80',
                    RequestLog:[],
                    Sources:[]
                },
                History:{
                    Stack:[],
                    Index:-1
                }
            },
            computed:{
                JSON:function()
                {
                    return JSON.stringify(this.API.Sources, null, 2);
                }
            },
            methods:{
                CORS: function(message, url, verb, success)
                {
                    var context = this;
                    var log = {
                        ID:Math.random(),
                        Message:message
                    };
                    context.API.RequestLog.push(log);

                    var xhr = new XMLHttpRequest();
                    if (!('withCredentials' in xhr)) xhr = new XDomainRequest(); // fix IE8/9
                    xhr.open(verb, url);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onload = function(request){
                        
                        var i;
                        for(i=0; i<context.API.RequestLog.length; i++)
                        {
                            if(context.API.RequestLog[i].ID == log.ID)
                            {
                                context.API.RequestLog.splice(i, 1);
                            }
                        }

                        var response = request.currentTarget.response || request.target.responseText;
                        console.log(response);
                        success.call(context, response);
                    };
                    xhr.send();
                    return xhr;
                },
                UpdateSource: function()
                {
                    this.CORS("Loading Sources", this.API.Domain+'/source', "GET", function(inResponse)
                    {
                        this.API.Sources = JSON.parse(inResponse).source_list;
                    });
                },
                HistoryPush: function()
                {
                    this.History.Stack.push(JSON.stringify(this.API.Sources, null, 2));
                    this.History.Index++;
                },
                HistoryRecall: function()
                {
                    this.API.Sources = JSON.parse(this.History.Stack[this.History.Index]);
                },
                HistoryForward: function()
                {
                    if(this.History.Index < this.History.Stack.length-1)
                    {
                        this.History.Index++;
                        this.HistoryRecall();
                    }
                },
                HistoryBack: function()
                {
                    if(this.History.Index > 0)
                    {
                        this.History.Index++;
                    }
                },
                ///////////////
                MemberCreate:function(inArray, inValue)
                {
                    inArray.unshift(inValue);
                },
                MemberUpdate:function(inArray, inIndex, inValue)
                {
                    inArray.splice(inIndex, 1, inValue);
                },
                MemberInsert:function(inArray, inIndex, inValue)
                {
                    inArray.splice(inIndex, 0, inValue);
                },
                MemberDuplicate:function(inArray, inIndex)
                {
                    var clone;
                    clone = JSON.parse(JSON.stringify( inArray[inIndex] ));
                    inArray.splice(inIndex, 0, clone);
                },
                MemberDelete:function(inArray, inIndex)
                {
                    inArray.splice(inIndex, 1);
                }
            }
        });
    </script>
</html>