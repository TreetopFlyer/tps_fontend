<!DOCTYPE html>
<html>
    <head>
        <script src="https://vuejs.org/js/vue.js"></script>
        <link rel="stylesheet" href="icomoon/font.css"></link>
        <style>
            *
            {
                font-family:Arial, Helvetica, sans-serif;
            }
            .Editor
            {
                border-radius: 3px;
                box-shadow: 0px 2px 3px #d4d4d4;
                padding: 8px;
                margin-bottom: 3px;
                border: 1px solid #aaa;
            }
            .Field
            {
                margin-top:3px;
                border-top:1px solid #eee;
            }
            .Label
            {
                display: inline-block;
                width: 100px;
                vertical-align: top;
                font-size:70%;
            }
            .Value
            {
                display: inline-block;
                padding:3px;
            }
            button
            {
                border:none;
                background:#eee;
                color:#333;
                border-radius:4px;
            }
            button span
            {
                display:none;
            }
            button:hover
            {
                background:#666;
                color:#eee;
            }
            .Column
            {
                display:block;
                float:left;
            }
            textarea
            {
                display:block;
                width:80%;
            }
        </style>
    </head>
    <body>
        <div id="App">
            <div class="Column Schema" style="width:20%;">
                <h3>1. Define Schema</h3>
                <input v-model="API.Schema" >
                <br>
                <button v-on:click=""><i class="icon icon-arrow-down"></i>Download</button>
                <hr>
                <textarea v-model="FormattedSchema" style="display: block; min-height: 400px;"></textarea>
            </div>
            <div class="Column Edit" style="width:40%;">
                <h3>2. Edit Model</h3>
                <input v-model="API.Download" >
                <br>
                <button v-on:click="APIDownload"><i class="icon icon-arrow-down"></i>Download</button>
                <hr>
                <type-dynamic :read="true" :object="Model" :definition="Schema"></type-dynamic>
            </div>
            <div class="Column Save" style="width:40%;">
                <h3>3. Save</h3>
                <input v-model="API.Upload" >
                <br>
                <button v-on:click=""><i class="icon icon-arrow-up"></i>Upload</button>
                <hr>
                <textarea v-model="FormattedModel" style="display: block; min-height: 400px;"></textarea>
            </div>
        </div>
    </body>

    <!-- editor-->
    <script>
    Vue.component("editor", {
        props:{
            object:Object,
            index:Number,
            list:Array,
            create:{default: false},
            templateName:{default:""},
            definition:Object
        },
        data:function()
        {
            return {
                edit:false,
                clone:{}
            }
        },
        created:function()
        {
            this.Clone();
        },
        methods:{
            Clone:function()
            {
                this.clone = JSON.parse(JSON.stringify(this.object));
            },
            Create:function()
            {
                this.list.unshift(JSON.parse(JSON.stringify(this.clone)));
            },
            Duplicate:function()
            {
                this.list.splice(this.index, 0, JSON.parse(JSON.stringify(this.object)));
            },
            Update:function()
            {
                this.list.splice(this.index, 1, this.clone);
            },
            Delete:function()
            {
                this.list.splice(this.index, 1);
            },
            ////////////
            EditStart:function()
            {
                this.Clone();
                this.edit = true;
            },
            EditCancel:function()
            {
                this.edit = false;
            },
            EditSave:function()
            {
                this.Update();
                this.edit = false;
            }
        },
        template:"#TemplateEditor"
    });
    </script>
    <script id="TemplateEditor" type="text/x-template">
        <div class="Editor">
            <form v-if="create" v-on:submit.prevent="Create">
                <!--<component :is="templateName" :write="true" :object="clone" :definition="definition"></component>-->
                <div class="Controls">
                    <button v-on:click.prevent="Create">    <i class="icon icon-plus-circle"></i> <span>Create</span></button>
                </div>
            </form>
            <form v-if="edit" v-on:submit.prevent="Update">
                <div class="Controls">
                    <button v-on:click.prevent="EditSave">  <i class="icon icon-save"></i>       <span>Update</span></button>
                    <button v-on:click.prevent="EditCancel"><i class="icon icon-slash"></i>      <span>Cancel</span></button>
                </div>
                <component :is="templateName" :write="true" :object="clone" :definition="definition"></component>
            </form>
            <div v-if="!create && !edit">
                <div class="Controls">
                    <button v-on:click.prevent="EditStart"><i class="icon icon-edit"></i>        <span>Edit</span></button>
                    <button v-on:click.prevent="Duplicate"><i class="icon icon-copy"></i>        <span>Duplicate</span></button>
                    <button v-on:click.prevent="Delete">   <i class="icon icon-trash-2"></i>     <span>Delete</span></button>
                </div>
                <component :is="templateName" :read="true" :object="object" :definition="definition"></component>
            </div>
        </div>
    </script>
    
    <!-- editor array -->
    <script>
        Vue.component("editor-array", {
            props:["list", "templateName", "definition"],// defaultSettings are defaults for the create mode form
            computed:{
                FormDefaults:function()
                {
                    var key, value;
                    var output = {};
                    for(key in this.definition)
                    {
                        value = this.definition[key];
                        output[key] = value.default;
                    }
                    return output;
                }
            },
            template:"#TemplateEditorArray"
        });
    </script>
    <script id="TemplateEditorArray" type="text/x-template">
        <div>
            <editor create="true"                   :index="-1"    :object="FormDefaults" :list="list" :templateName="templateName" :definition="definition"></editor>
            <editor v-for="(object, index) in list" :index="index" :object="object"       :list="list" :templateName="templateName" :definition="definition"></editor>
        </div>
    </script>

    <!-- mixin DataType-->
    <script>
    var MixinDataType = {
        props:{
            read:{default:false},
            write:{default:false},
            object:{default:function(){return {};}}
        },
        data:function()
        {
            return {open:false}
        },
        methods:{
            Toggle:function()
            {
                this.open = !this.open;
            }
        }
    }
    </script>
    <!-- Data Type: Dynamic -->
    <script>
    Vue.component("type-dynamic", {
        mixins:[MixinDataType],
        props:{definition:Object},
        computed:{
            Schema:function()
            {
                var key, value;
                var output;
                output = {
                    Leaves:[],
                    Branches:[]
                };
                for(key in this.definition)
                {
                    value = this.definition[key];
                    value.key = key;
                    if(typeof value.display === "undefined")
                    {
                        // if theres no display value, use the key
                        value.display = key;
                    }
                    if(value.type == "array")
                    {
                        output.Branches.push(value);
                    }
                    else
                    {
                        output.Leaves.push(value);
                    }

                    // put defined properties and their defaults on object if they dont exists
                    if(typeof this.object[key] === "undefined" && typeof value.default !== "undefined")
                    {
                        this.object[key] = value.default;
                    }
                }
                return output;
            }
        },
        template:"#TemplateDataTypeDynamic"
    })
    </script>
    <script id="TemplateDataTypeDynamic" type="text/x-template">
        <div>
            <div v-if="write">
                <div class="Field" v-for="leaf in Schema.Leaves">
                    <div class="Label">{{leaf.display}}:</div>
                    <div class="Value"><component :is="'leaf-'+leaf.type" v-model="object[leaf.key]" :display="leaf.display" :settings="leaf.settings"></component></div>
                </div>
            </div>
            <div v-if="read">
                <div class="Field" v-for="leaf in Schema.Leaves">
                    <div class="Label">{{leaf.display}}:</div>
                    <div class="Value">{{object[leaf.key]}}</div>
                </div>
            </div>
            <div v-if="open && Schema.Branches.length > 0">
                <button v-on:click="Toggle">
                    <i class="icon icon-chevron-up"></i>
                    <a>Hide Chidren</a>
                </button>
                <div class="Field" v-for="branch in Schema.Branches">
                    <div class="Label">{{branch.display}}: </div>
                    <div class="Value"><editor-array template-name="type-dynamic" :list="object[branch.key]" :definition="branch.settings"></editor-array></div>
                </div>
            </div>
            <div v-if="!open && Schema.Branches.length > 0">
                <button v-on:click="Toggle">
                    <i class="icon icon-chevron-down"></i>
                    <a>Show Chidren</a>
                </button>
            </div>
        </div>
    </script>
    
    <!-- mixin Leaves -->
    <script>
    var MixinLeaf = {
        props:{
            display:{default:"Field"},
            value:{default:"--empty--"},
            settings:[Object, Array]
        },
        methods:{
            Dispatch:function(inEvent){ this.$emit("input", inEvent.target.value); }
        }
    };
    </script>
    <!-- Leaf: String -->
    <script>
    Vue.component("leaf-string", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafString"
    });
    </script>
    <script id="TemplateLeafString" type="text/x-template">
        <div>
            <input :value="value" v-on:input="Dispatch" type="text">
        </div>
    </script>
    <!-- Leaf: Number -->
    <script>
    Vue.component("leaf-number", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafNumber"
    });
    </script>
    <script id="TemplateLeafNumber" type="text/x-template">
        <div>
            <input :value="value" v-on:input="Dispatch" type="number">
        </div>
    </script>
    <!-- Leaf: Boolean -->
    <script>
    Vue.component("leaf-boolean", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafBoolean"
    });
    </script>
    <script id="TemplateLeafBoolean" type="text/x-template">
        <div>
            <input :checked="value" v-on:change="$emit('input', $event.target.checked)" type="checkbox">
        </div>
    </script>
    <!-- Leaf: Enum -->
    <script>
    Vue.component("leaf-enum", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafEnum"
    });
    </script>
    <script id="TemplateLeafEnum" type="text/x-template">
        <div>
            <select v-on:change="Dispatch" :value="value">
                <option v-for="option in settings" :value="option" selected="">{{option}}</option>
            </select>
        </div>
    </script>

    <!-- application -->
    <script>
        var App = new Vue({
            el:"#App",
            data:
            {
                API:{
                    Download:"http://localhost:80/source",
                    Upload:"http://localhost:80/",
                    Schema:"http://localhost:80/",

                    RequestLog:[],
                    Sources:[]
                },
                History:{
                    Stack:[{Type:"Initialized", Data:"{}"}],
                    Index:0
                },

                /*
                - array *defaults* are used to seed the array with values when its component is initialized
                - non-array *defaults* are used to build the form that creates new types that will go in the parent array
                - if an item has defaults, that property will be created on the model object if it doesnt exist
                */
                Schema:
                {
                    source_list:{type:"array", default:[], settings:{
                        name:{type:"string", default:"new source"},
                        source:{type:"enum", default:"client_file", settings:["client_file", "api"]},
                        loading_function:{type:"enum", default:"csv", display:"loading function", settings:["xml", "csv", "json"]},
                        constraint:{type:"array", default:[], settings:{
                            accessor:{type:"string", default:"{column}"}
                        }},
                        schemas:{type:"array", default:[], settings:{
                            name:{type:"string", default:"new schema"},
                            columns:{type:"array", default:[], settings:{
                                column_name:{type:"string", default:"new column"},
                                path:{type:"string", default:"{path}"},
                                type:{type:"enum", default:"text", settings:["text", "date", "numeric"]}
                            }}
                        }}
                    }}
                },
                Model:{}
            },
            computed:{
                FormattedSchema:function()
                {
                    return JSON.stringify(this.Schema, null, 2);
                },
                FormattedModel:function()
                {
                    return JSON.stringify(this.Model, null, 2);
                }
            },
            methods:{
                Switcheroo:function()
                {
                    this.Model = {
                        members:[
                            {name:"seth", age:35, deep:[]}
                        ]
                    }
                },
                QueueRemove: function(inObj)
                {
                    var i;
                    for(i=0; i<this.API.RequestLog.length; i++)
                    {
                        if(this.API.RequestLog[i].ID == inObj.ID)
                        {
                            this.API.RequestLog.splice(i, 1);
                        }
                    }
                },
                QueueAdd: function(inObj)
                {
                    this.API.RequestLog.push(inObj);
                },
                CORS: function(inMessage, inURL, inVerb, inSuccessHandler, inBody)
                {
                    var context;
                    var log;
                    var xhr;
                    context = this;
                    log = {
                        ID:Math.random(),
                        Message:inMessage
                    };
                    this.QueueAdd(log);
                    xhr = new XMLHttpRequest();
                    if (!('withCredentials' in xhr)) xhr = new XDomainRequest(); // fix IE8/9
                    xhr.open(inVerb, inURL);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onload = function(request)
                    { 
                        var response;
                        context.QueueRemove(log);
                        response = request.currentTarget.response || request.target.responseText;
                        console.log(response);
                        inSuccessHandler.call(context, response);
                    };
                    xhr.onerror = function()
                    {
                        console.log("xhr error");
                        context.QueueRemove(log);
                    };
                    xhr.send(inBody);
                    return xhr;
                },
                APIDownload: function()
                {
                    this.CORS("Downloading Data", this.API.Download, "GET", function(inResponse)
                    {
                        this.Model = JSON.parse(inResponse);
                        this.HistoryPush("Download");
                    });
                },
                APIUpload: function()
                {
                    this.HistoryPush("Uploading Data");
                    this.CORS("Saving Sources", this.API.Upload, "POST", function(inResponse)
                    {
                        alert(inResponse);
                    },
                    JSON.stringify(this.API.Sources));
                },
                HistoryPush: function(inType)
                {
                    /*
                    // if there's no change in the type of action, do noting (effectively combining edits)
                    if(this.HistoryCurrent().Type == inType)
                    {
                        return;
                    }
                    */
                    
                    // if we have gone back and are now adding a new item, delete everything ahead of this first
                    if(this.History.Index != this.History.Stack.length-1)
                    {
                        this.History.Stack.splice(this.History.Index+1);
                    }
                    this.History.Stack.push({Type:inType, Data:JSON.stringify(this.Model, null, 2)});
                    // limit to 20 items
                    if(this.History.Stack.length > 20)
                    {
                        this.History.Stack.shift();
                    }
                    this.History.Index = this.History.Stack.length-1;
                },
                HistoryCurrent: function()
                {
                    return this.History.Stack[this.History.Index];
                },
                HistoryRecall: function(inIndex)
                {
                    this.History.Index = inIndex;
                    this.Model = JSON.parse(this.History.Stack[inIndex].Data);
                },
                HistoryForward: function()
                {
                    if(this.HistoryCanGoForward())
                    {
                        this.HistoryRecall(this.History.Index+1);
                    }
                },
                HistoryBack: function()
                {
                    if(this.HistoryCanGoBack())
                    {
                        this.HistoryRecall(this.History.Index-1);
                    }
                },
                HistoryCanGoBack: function()
                {
                    return this.History.Index > 0;
                },
                HistoryCanGoForward: function()
                {
                    return this.History.Index < this.History.Stack.length-1;
                }
            }

        });
    </script>
</html>