<!DOCTYPE html>
<html>
    <head>
        <script src="https://vuejs.org/js/vue.js"></script>
    </head>
    <body>
        <div id="App">
            <div v-for="source in API.Sources">
                <tps-source :source="source"/>
            </div>
        </div>
    </body>

    <!-- editor -->
    <script>
    var MixinEditor = {
        props:{
            createMode:{type:Boolean, default:false},
            editMode:{type:Boolean, default:false}
        },
        data:function()
        {
            return {
                Internal:this.CloneFields(this),
                Edit:this.editMode,
                Create:this.createMode
            }
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {};
            },
            EditStart:function()
            {
                this.Edit = true;
                this.Internal = this.CloneFields(this);
            },
            EditUpdate:function()
            {
                this.Edit = false;
                this.$emit('update', this.CloneFields(this.Internal));
            },
            EditCancel:function()
            {
                this.Edit = false;
            },
            EditDelete:function()
            {
                this.$emit('delete');
            },
            EditCreate:function()
            {
                this.$emit('create', this.CloneFields(this.Internal));
            }
        }
    };
    var MixinEditorColumn = {
        props:{
            column_name:{default:'New Column'},
            path:{default:'{path}'},
            type:{default:'text'}
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {
                    column_name: inObj.column_name,
                    path: inObj.path,
                    type: inObj.type
                };
            }
        }
    };
    var MixinEditorHeading = {
        props:{
            title:{default:'New Schema'},
        },
        methods:{
            CloneFields:function(inObj)
            {
                return {
                    title: inObj.title
                };
            }
        }
    };
    </script>
        

    <!-- column -->
    <script>
    Vue.component("column", {
        mixins:[MixinEditor, MixinEditorColumn],
        template:"#TemplateColumn"
    });
    </script>
    <script id="TemplateColumn" type="text/x-template">
        <div>
            <div v-if="Edit || Create">
                <input type="text" v-model="Internal.column_name">
                <br/>
                <input type="text" v-model="Internal.path">
                <br/>
                <select v-model="Internal.type">
                    <option disabled>{{Internal.type}}</option>
                    <option>date</option>
                    <option>numeric</option>
                    <option>text</option>
                </select>
                <br/>
                <div v-if="Create">
                    <button v-on:click="EditCreate">Create</button>
                </div>
                <div v-else>
                    <button v-on:click="EditUpdate">Update</button>
                    <button v-on:click="EditCancel">Cancel</button>
                    <button v-on:click="EditDelete">Delete</button>
                </div>
            </div>
            <div v-else>
                <strong>{{column_name}}</strong><br/>
                <span>{{path}}</span><br/>
                <em>{{type}}</em><br/>
                <button v-on:click="EditStart">Edit</button>
            </div>
        </div>
    </script>
    
    
    <!-- header -->
    <script>
    Vue.component("heading", {
        mixins:[MixinEditor, MixinEditorHeading],
        template:"#TemplateHeading"
    });
    </script>
    <script id="TemplateHeading" type="text/x-template">
        <div>
            <div v-if="Edit || Create">
                <input type="text" v-model="Internal.title">
                <br/>
                <div v-if="Create">
                    <button v-on:click="EditCreate">Create</button>
                </div>
                <div v-else>
                    <button v-on:click="EditUpdate">Update</button>
                    <button v-on:click="EditCancel">Cancel</button>
                    <button v-on:click="EditDelete">Delete</button>
                </div>
            </div>
            <div v-else>
                <strong>{{title}}</strong><br/>
                <button v-on:click="EditStart">Edit</button>
            </div>
        </div>
    </script>
    
    
    <!-- schema -->
    <script>
    Vue.component("schema", {
        delimiters: ['${', '}'],
        props:{
            title:{
                type:String,
                default:"default"
            },
            members:{
                type:Array,
                default:[]
            }
        },
        methods:{
            ColumnCreate:function(inEvent)
            {
                this.members.push(inEvent);
            },
            ColumnUpdate:function(inIndex, inEvent)
            {
                this.members.splice(inIndex, 1, inEvent);
            },
            ColumnDelete:function(inIndex)
            {
                this.members.splice(inIndex, 1);
            }
        },
        template:"#TemplateSchema"
    });
    </script>
    <script id="TemplateSchema" type="text/x-template">
        <div>
            <heading v-bind:title="title"></heading>
            <table>
                <tr>
                    <th v-for="(value, index) in members">
                        <column
                            v-bind="value"
                            v-bind:key="value.column_name+value.path"
                            v-on:delete="ColumnDelete(index)"
                            v-on:update="ColumnUpdate(index, $event)"/>
                    </th>
                    <th>
                        <column createMode v-on:create="ColumnCreate"/>
                    </th>
                </tr>
            </table>
        </div>
    </script>

    <!-- source -->
    <script>
        Vue.component("tps-source", {
            delimiters: ['${', '}'],
            props:['source'],
            data: function()
            {
                return {
                    Edit:false,
                    Copy:{},
                    Temp:{
                        Constraint:'',
                        Column:{column_name:'Trans. Date', path:'{Trans. Date}', type:'date'}
                    }
                };
            },
            methods:
            {
                EditStart: function()
                {
                    this.Edit = true;
                    this.Copy = JSON.parse(JSON.stringify(this.source));
                },
                EditCancel: function()
                {
                    this.Edit = false;
                },
                ConstraintRemove: function(inIndex)
                {
                    this.Copy.constraint.splice(inIndex, 1);
                },
                ConstraintAdd: function()
                {
                    this.Copy.constraint.push(this.Temp.Constraint);
                    this.Temp.Constraint = '';
                }
            },
            computed:
            {

            },
            mounted:function()
            {

            },
            template:"#TemplateSource"
        });
    </script>
    <script id="TemplateSource" type="text/x-template">
        <div class="Source">
            <dl v-show="!Edit">
                <dt v-html="source.name"></dt>
                <dd><strong>Loading Function: </strong><span v-html="source.loading_function"></span></dd>
                <dd><strong>Source: </strong><span v-html="source.source"></span></dd>
                <dd><strong>Contsraints: </strong><span v-html="source.constraint.join(' ')"></span></dd>
                <dd><strong>Schemas: </strong><span v-html=""></span></dd>
                <dd><button v-on:click="EditStart">Edit</button></dd>
            </dl>
            <dl v-show="Edit">
                <dd><input v-model="Copy.name"/></dd>
                <dd>
                    <strong>Schemas:</strong>
                    <ul>
                        <li v-for="(value, key) in Copy.schemas">
                            <schema v-bind:title="key" v-bind:members="value" />
                        </li>
                    </ul>
                </dd>
                <dd><button v-on:click="EditCancel">Cancel</button></dd>
            </dl>
        </div>
    </script>

    <!-- application -->
    <script>
        var App = new Vue({
            delimiters: ['${', '}'],
            el:"#App",
            data:{
                API:{
                    Domain:'//localhost:80',
                    RequestLog:[],
                    Sources:[
                        {
                            "name":"dcard",
                            "source":"client_file",
                            "schemas":{
                                "mapped":[{"path":"{Trans. Date}","type":"date","column_name":"Trans. Date"},{"path":"{Post Date}","type":"date","column_name":"Post Date"},{"path":"{Description}","type":"text","column_name":"Description"},{"path":"{Amount}","type":"numeric","column_name":"Amount"},{"path":"{Category}","type":"text","column_name":"Category"},{"path":"{party}","type":"text","column_name":"Party"},{"path":"{reason}","type":"text","column_name":"Reason"}],
                                "default":[{"path":"{Trans. Date}","type":"date","column_name":"Trans. Date"},{"path":"{Post Date}","type":"date","column_name":"Post Date"},{"path":"{Description}","type":"text","column_name":"Description"},{"path":"{Amount}","type":"numeric","column_name":"Amount"},{"path":"{Category}","type":"text","column_name":"Category"}]
                            },
                            "constraint":["{Trans. Date}","{Post Date}","{Description}"],
                            "loading_function":"csv"
                        }
                    ]
                }
            },
            methods:{
                CORS: function(message, url, verb, success)
                {
                    var context = this;
                    var log = {
                        ID:Math.random(),
                        Message:message
                    };
                    context.API.RequestLog.push(log);

                    var xhr = new XMLHttpRequest();
                    if (!('withCredentials' in xhr)) xhr = new XDomainRequest(); // fix IE8/9
                    xhr.open(verb, url);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onload = function(request){
                        
                        var i;
                        for(i=0; i<context.API.RequestLog.length; i++)
                        {
                            if(context.API.RequestLog[i].ID == log.ID)
                            {
                                context.API.RequestLog.splice(i, 1);
                            }
                        }

                        var response = request.currentTarget.response || request.target.responseText;
                        console.log(response);
                        success.call(context, response);
                    };
                    xhr.send();
                    return xhr;
                },
                UpdateSource: function()
                {
                    this.CORS("Loading Sources", this.API.Domain+'/source', "GET", function(inResponse)
                    {
                        this.API.Sources = JSON.parse(inResponse).source_list;
                    });
                }
            },
            mounted:function()
            {
                //this.UpdateSource();
            }
        });
    </script>
</html>