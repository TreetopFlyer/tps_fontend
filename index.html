<!DOCTYPE html>
<html>
    <head>
        <style>
            .Node
            {
                border:1px dotted #ddd;
                padding:8px;
            }
        </style>
    </head>
    <body>
        <div id="App">
        </div>

        <!-- model/schema -->
        <script>
            var Model = {
                sources:[
                    {
                        name:"Source1",
                        type:"xml"
                    }
                ]
            };
            var Schema = {
                Root:{
                    client:{type:"string", default:"default client"},
                    sources:{type:"array", settings:"Source"}
                },
                Source:{
                    name:{type:"string", default:"new source", display:"Source"},
                    type:{type:"enum", default:"xml", display:"Type", settings:["xml", "json", "csv"]},
                    layouts:{type:"array", default:[{name:"Default Layout!"}], settings:"Layout"}
                },
                Layout:{
                    name:{type:"string", default:"new layout", display:"Layout"},
                    columns:{type:"array", default:[{name:"Product", type:"string"}, {name:"Date", type:"date"}], settings:"Column"}
                },
                Column:{
                    name:{type:"string", default:"new column", display:"Column"},
                    type:{type:"enum", default:"text", display:"Type", settings:["text", "date", "number", "boolean"]}
                }
            };
            function Merge(inModel, inSchema, inPattern)
            {
                var i;
                var output, property;
                var pattern;
                var patternKey, patternValue, modelValue;
            
                pattern = inSchema[inPattern];
                output = {
                    Leaves:[],
                    Branches:[],
                    State:{
                        Edit:false,
                        Collapsed:false,
                    },
                    Methods:{
                        EditStart:()=>
                        {
                            output.State.Edit = true;
                        },
                        EditCancel:()=>
                        {
                            output.State.Edit = false;
                        },
                        EditSave:()=>
                        {
                            output.State.Edit = false;
                        },
                        BranchAdd:()=>
                        {

                        },
                        BranchDuplicate:()=>
                        {

                        },
                        BranchDelete:()=>
                        {

                        }
                    }
                };
                for(patternKey in pattern)
                {
                    patternValue = pattern[patternKey];
                    modelValue = inModel[patternKey]||patternValue.default||"-NA-";
            
                    property = {
                        Key:patternKey,
                        Value:modelValue,
                        Annotation:patternValue
                    };
            
                    if(patternValue.type === "array")
                    {
                        var replacement = [];
                        //replace the array of objects inValue with an array of merged objects
                        for(i=0; i<modelValue.length; i++)
                        {
                            replacement.push( Merge(modelValue[i], inSchema, patternValue.settings) );
                        }
                        property.Value = replacement;
                        output.Branches.push(property);
                    }
                    else
                    {
                        output.Leaves.push(property);
                    }
                }
                return output;
            }
            function Split(inMerge)
            {
                var i, j;
                var item;
                var obj;
                var array;
                obj = {};
                for(i=0; i<inMerge.Leaves.length; i++)
                {
                    item = inMerge.Leaves[i];
                    obj[item.Key] = item.Value;
                }
                for(i=0; i<inMerge.Branches.length; i++)
                {
                    array = [];
                    item = inMerge.Branches[i];
                    for(j=0; j<item.Value.length; j++)
                    {
                        array.push( Split(item.Value[j]) );
                    }
                    obj[item.Key] = array;
                }
                return obj;
            }
            var merge = Merge(Model, Schema, "Root");
            var split = Split(merge);
        </script>
        
        <!-- lit-html -->
        <script type="module">
            import {html, render} from 'https://unpkg.com/lit-html?module';
            let _Node = (inMerged) =>
            {
                return html`
                <div class="Node">
                    <h2>${inMerged.State.Edit}</h2>
                    ${inMerged.Leaves.map( (inItem)=>
                    {
                        return html`
                        <div class="Leaf">
                            ${inItem.Key}: ${inItem.Value}
                        </div>
                        `;
                    }) }
                    <button @click=${() => inMerged.Methods.EditStart()}>Edit</button>
                    <button @click=${() => inMerged.Methods.EditCancel()}>Cancel</button>
                    ${inMerged.Branches.map( (inItem)=>
                    {
                        return html`
                        <div class="Branch">
                            ${inItem.Key}: ${inItem.Value.map( (inMember)=>
                            {
                                return _Node(inMember);
                            } )}
                        </div>
                        `;
                    })}
                </div>
                `;
            }
            let Redraw = () =>
            {
                render(_Node(merge), document.querySelector("#App"));
            }
            setInterval(Redraw, 500);
        </script>
    </body>
</html>