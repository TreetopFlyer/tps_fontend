<!DOCTYPE html>
<html>
    <head>
        <script src="https://vuejs.org/js/vue.js"></script>
        <style>
            .Editor
            {
                padding:1em;
                border:1px solid #aaa;
            }
        </style>
    </head>
    <body>
        <div id="App">
            <type-dynamic :read="true" :object="Model" :definition="Schema"></type-dynamic>
        </div>
    </body>

    <!-- editor-->
    <script>
    Vue.component("editor", {
        props:{
            object:Object,
            index:Number,
            list:Array,
            create:{default: false},
            templateName:{default:""},
            definition:Object
        },
        data:function()
        {
            return {
                edit:false,
                clone:{}
            }
        },
        mounted:function()
        {
            this.Clone();
        },
        methods:{
            Clone:function()
            {
                this.clone = JSON.parse(JSON.stringify(this.object));
            },
            Create:function()
            {
                this.list.push(JSON.parse(JSON.stringify(this.clone)));
            },
            Duplicate:function()
            {
                this.list.splice(this.index, 0, JSON.parse(JSON.stringify(this.object)));
            },
            Update:function()
            {
                this.list.splice(this.index, 1, this.clone);
            },
            Delete:function()
            {
                this.list.splice(this.index, 1);
            },
            ////////////
            EditStart:function()
            {
                this.Clone();
                this.edit = true;
            },
            EditCancel:function()
            {
                this.edit = false;
            },
            EditSave:function()
            {
                this.Update();
                this.edit = false;
            }
        },
        template:"#TemplateEditor"
    });
    </script>
    <script id="TemplateEditor" type="text/x-template">
        <div class="Editor">
            <form v-if="create" v-on:submit.prevent="Create">
                <component :is="templateName" :write="true" :object="clone" :definition="definition"></component>
                <div class="Controls">
                    <button v-on:click.prevent="Create">    <i class="icon icon-plus-circle"></i> <span>Create</span></button>
                </div>
            </form>
            <form v-if="edit" v-on:submit.prevent="Update">
                <div class="Controls">
                    <button v-on:click.prevent="EditSave">  <i class="icon icon-save"></i>       <span>Update</span></button>
                    <button v-on:click.prevent="EditCancel"><i class="icon icon-slash"></i>      <span>Cancel</span></button>
                </div>
                <component :is="templateName" :write="true" :object="clone" :definition="definition"></component>
            </form>
            <div v-if="!create && !edit">
                <div class="Controls">
                    <button v-on:click.prevent="EditStart"><i class="icon icon-edit"></i>        <span>Edit</span></button>
                    <button v-on:click.prevent="Duplicate"><i class="icon icon-copy"></i>        <span>Duplicate</span></button>
                    <button v-on:click.prevent="Delete">   <i class="icon icon-trash-2"></i>     <span>Delete</span></button>
                </div>
                <component :is="templateName" :read="true" :object="object" :definition="definition"></component>
            </div>
        </div>
    </script>
    
    <!-- editor array -->
    <script>
        Vue.component("editor-array", {
            props:["list", "templateName", "definition"],// defaultSettings are defaults for the create mode form
            computed:{
                formDefaults:function()
                {
                    var key, value;
                    var output = {};
                    for(key in this.definition)
                    {
                        value = this.definition[key];
                        output[key] = value.default;
                    }
                    return output;
                }
            },
            template:"#TemplateEditorArray"
        });
    </script>
    <script id="TemplateEditorArray" type="text/x-template">
        <div>
            <editor create="true"                   :index="-1"    :object="formDefaults" :list="list" :templateName="templateName" :definition="definition"></editor><hr>
            <editor v-for="(object, index) in list" :index="index" :object="object"       :list="list" :templateName="templateName" :definition="definition"></editor> <!---->
        </div>
    </script>


    <!-- mixin DataType-->
    <script>
    var MixinDataType = {
        props:{
            read:{default:false},
            write:{default:false},
            object:{default:function(){return {};}}
        }
    }
    </script>
    <!-- Data Type: Source -->
    <script>
    Vue.component("type-source", {
        mixins:[MixinDataType],
        template:"#TemplateDataTypeSource"
    });
    </script>
    <script id="TemplateDataTypeSource" type="text/x-template">
        <div>
            <div v-if="read">
                <h3>{{object.name}} | {{object.data}}</h3>
            </div>
            <div v-if="write">
                <component is="leaf-string" v-model="object.name" display="Name"></component>
                <component is="leaf-number" v-model="object.data" display="Data"></component>
                <editor-array
                    :default-settings="{name:'child', type:'CSV', active:false}"
                    :list="object.children"
                    data-type="type-child">
                </editor-array>
            </div>
        </div>
    </script>
    <!-- Data Type: Dynamic -->
    <script>
    Vue.component("type-dynamic", {
        mixins:[MixinDataType],
        props:{definition:Object},
        computed:{
            Schema:function()
            {
                var key, value;
                var output;
                output = {
                    Leaves:[],
                    Branches:[]
                };
                for(key in this.definition)
                {
                    value = this.definition[key];
                    value.key = key;
                    if(typeof value.display === "undefined")
                    {
                        // if theres no display value, use the key
                        value.display = key;
                    }
                    if(value.type == "array")
                    {
                        output.Branches.push(value);
                    }
                    else
                    {
                        output.Leaves.push(value);
                    }
                }
                return output;
            }
        },
        mounted:function()
        {

        },
        template:"#TemplateDataTypeDynamic"
    })
    </script>
    <script id="TemplateDataTypeDynamic" type="text/x-template">
        <div>
            <div v-if="write">
                <component v-for="leaf in Schema.Leaves" :is="'leaf-'+leaf.type" v-model="object[leaf.key]" :display="leaf.display" :settings="leaf.settings"></component>
            </div>
            <div v-if="read">
                <div v-for="leaf in Schema.Leaves">{{object[leaf.key]}}</div>
                <editor-array v-for="branch in Schema.Branches" template-name="type-dynamic" :list="object[branch.key]" :definition="branch.settings"></editor-array>
            </div>
        </div>
    </script>


    <!-- mixin Leaves -->
    <script>
    var MixinLeaf = {
        props:{
            display:{default:"Field"},
            value:{default:"-empty-"},
            settings:[Object, Array]
        },
        methods:{
            Dispatch:function(inEvent){ this.$emit("input", inEvent.target.value); }
        }
    };
    </script>
    <!-- Leaf: String -->
    <script>
    Vue.component("leaf-string", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafString"
    });
    </script>
    <script id="TemplateLeafString" type="text/x-template">
        <div>
            <label>{{display}}</label>
            <input :value="value" v-on:input="Dispatch" type="text">
        </div>
    </script>
    <!-- Leaf: Number -->
    <script>
    Vue.component("leaf-number", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafNumber"
    });
    </script>
    <script id="TemplateLeafNumber" type="text/x-template">
        <div>
            <label>{{display}}</label>
            <input :value="value" v-on:input="Dispatch" type="number">
        </div>
    </script>
    <!-- Leaf: Boolean -->
    <script>
    Vue.component("leaf-boolean", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafBoolean"
    });
    </script>
    <script id="TemplateLeafBoolean" type="text/x-template">
        <div>
            <label>{{display}}</label>
            <input :value="value" v-on:change="Dispatch" type="checkbox">
        </div>
    </script>
    <!-- Leaf: Enum -->
    <script>
    Vue.component("leaf-enum", {
        mixins:[MixinLeaf],
        template:"#TemplateLeafEnum"
    });
    </script>
    <script id="TemplateLeafEnum" type="text/x-template">
        <div>
            <label>{{display}}</label>
            <select v-on:change="Dispatch" :value="value">
                <option v-for="option in settings" :value="option" selected="">{{option}}</option>
            </select>
        </div>
    </script>

    <!-- application -->
    <script>
        /*
        api endpoints:
        - Type
        - Load
        - Save
        */
        var App = new Vue({
            el:"#App",
            data:
            {
                Schema:
                {
                    thing:{type:"string", default:"hey"},
                    members:{type:"array", default:[{name:'default1', age:7, deep:[]}, {name:'default2', age:8, deep:[]}], settings:{
                        name:{type:"string", default:"dm"},
                        age:{type:"number", default:10},
                        deep:{type:"array", default:[{count:0}, {count:1}, {count:3}], settings:{
                            count:{type:"number", default:-10}
                        }}
                    }}
                    /*
                    Sources:{type:"array", default:[], settings:{
                        name:{type:"string", default:"new source"},
                        data:{type:"number", default:1},
                        children:{type:"array", default:[], settings:{
                            name:{type:"string", default:"new child"},
                            type:{type:"enum", default:"JSON", settings:["JSON", "CSV", "XML"]},
                            active:{type:"boolean", default:"false"}
                        }}
                    }}
                    */
                },
                Model:{
                    thing:"test leaf value",
                    members:[]
                }
            }
        });
    </script>
</html>